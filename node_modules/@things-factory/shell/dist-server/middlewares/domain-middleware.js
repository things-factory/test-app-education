"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@things-factory/utils");
const typeorm_1 = require("typeorm");
const url_1 = require("url");
const entities_1 = require("../entities");
async function domainMiddleware(context, next) {
    try {
        var { request } = context;
        var { header } = request;
        var { referer } = header;
        var domain;
        var pathInfo;
        if (referer) {
            var { pathname } = new url_1.URL(referer);
            pathInfo = utils_1.getPathInfo(pathname);
        }
        domain = request.get('x-things-factory-domain') || (pathInfo === null || pathInfo === void 0 ? void 0 : pathInfo.domain);
        var domainObj = {};
        if (domain) {
            var repo = typeorm_1.getRepository(entities_1.Domain);
            var d = await repo.findOne({
                where: [{ subdomain: domain }],
                cache: true
            });
            if (d) {
                domainObj = d;
            }
        }
        context.state.domain = domainObj;
        return next();
    }
    catch (e) {
        return next();
    }
}
exports.domainMiddleware = domainMiddleware;
//# sourceMappingURL=domain-middleware.js.map